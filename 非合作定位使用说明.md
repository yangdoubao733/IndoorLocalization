# 非合作定位功能使用说明

> **🆕 新功能提示**: 系统已升级支持**通用电磁信号跟踪**，可定位WiFi、蓝牙、手机信号、RFID、ZigBee、LoRa、UWB等多种信号源！
> 详见: [通用电磁信号跟踪说明.md](通用电磁信号跟踪说明.md)

## 功能概述

非合作定位功能允许系统**自动检测和跟踪**环境中的电磁信号设备（如手机、笔记本、蓝牙设备、RFID标签等），**无需目标设备主动配合**。系统通过监听或模拟设备发出的电磁信号来实时定位其位置。

### 支持的信号类型
- ✅ **WiFi** (2.4GHz/5GHz) - 手机、笔记本、智能家居
- ✅ **Bluetooth** (2.4GHz) - 蓝牙耳机、智能手环、信标
- ✅ **Cellular** (700MHz-2.6GHz) - 手机蜂窝信号
- ✅ **RFID** (13.56MHz/915MHz) - 资产标签、门禁卡
- ✅ **ZigBee** (2.4GHz) - 智能家居传感器
- ✅ **LoRa** (433MHz/868MHz/915MHz) - 物联网设备
- ✅ **UWB** (3.1-10.6GHz) - 高精度定位标签

## 两种工作模式

### 1. 模拟模式（Simulated Mode）
**用途**：用于测试和演示，无需真实硬件设备

**特点**：
- ✅ 无需购买专业WiFi设备
- ✅ 快速验证算法和系统功能
- ✅ 可以模拟多个设备移动
- ✅ 使用指纹库或射线追踪生成RSSI数据

**适用场景**：
- 系统开发和调试
- 算法性能测试
- 演示和教学

### 2. 真实AP模式（Real AP Mode）
**用途**：连接真实WiFi AP设备，进行实际环境定位

**特点**：
- 📡 需要支持Monitor Mode的WiFi设备
- 📡 可以跟踪真实的手机、电脑等设备
- 📡 真正的非合作目标定位
- 📡 需要配置AP的IP地址和通信协议

**适用场景**：
- 实际部署应用
- 真实环境测试
- 商业场景（需合法授权）

## 使用流程

### 准备工作
1. **构建指纹库**：在"1. 构建指纹库"页面完成指纹库构建
2. **加载指纹库**：在"2. 定位测试"页面加载指纹库和定位引擎

### 模拟模式使用步骤

#### 第1步：选择模拟模式
- 打开"3. 非合作定位"选项卡
- 选择"模拟模式 (用于测试，无需真实AP)"

#### 第2步：初始化跟踪系统
- 点击"初始化跟踪系统"按钮
- 系统会创建模拟信号采集器和设备跟踪器
- 状态显示为"已初始化 (simulated模式)"

#### 第3步：添加模拟设备
- 在"设备管理"区域：
  - **MAC地址**：输入设备MAC地址，如 `AA:BB:CC:DD:EE:FF`
  - **位置 (x,y,z)**：输入设备初始位置，如 `5,5,1.5`（单位：米）
- 点击"添加模拟设备"
- 可以添加多个设备进行测试

#### 第4步：开始跟踪
- 点击"开始跟踪"按钮
- 系统每1秒自动更新设备位置
- 设备列表每2秒自动刷新显示

#### 第5步：查看结果
- **设备列表**：表格显示所有设备的实时位置、置信度、最后更新时间
- **实时地图**：点击"查看实时地图"生成3D可视化地图
  - 显示指纹点（灰色）
  - 显示AP位置（红色菱形）
  - 显示跟踪设备（蓝色圆点）
  - 支持3D交互旋转、缩放

#### 第6步：停止跟踪
- 点击"停止跟踪"按钮结束实时跟踪

### 真实AP模式使用步骤

#### 第1步：准备硬件
- 需要4个（或更多）支持Monitor Mode的WiFi AP设备
- 每个AP设备运行信号监听程序（见下文"AP端程序"）
- 确保AP设备与PC在同一网络

#### 第2步：选择真实AP模式
- 选择"真实AP模式 (需要连接真实AP设备)"
- 输入AP设备的配置：
  - **AP IP地址**：输入各AP的IP地址，用逗号分隔
    - 例如：`192.168.1.101,192.168.1.102,192.168.1.103,192.168.1.104`
  - **通信端口**：默认 `9999`

#### 第3步：初始化和跟踪
- 点击"初始化跟踪系统"
  - 系统会尝试连接所有AP设备
  - 显示连接成功的AP数量
- 点击"扫描设备"查看环境中的WiFi设备
- 点击"开始跟踪"开始实时定位
- 后续操作同模拟模式

## AP端程序示例

如果使用真实AP模式，需要在每个AP设备上运行监听程序：

```python
# ap_monitor.py - 在AP设备上运行
import socket
import json
from scapy.all import *

AP_PORT = 9999

def get_rssi(target_mac):
    """获取目标设备的RSSI"""
    # 实现信号强度监听逻辑
    # 返回RSSI值（dBm）
    pass

def scan_devices():
    """扫描所有设备"""
    # 返回MAC地址列表
    pass

def handle_request(data):
    """处理来自定位系统的请求"""
    request = json.loads(data.decode())
    command = request.get('command')

    if command == 'get_rssi':
        mac = request['target_mac']
        rssi = get_rssi(mac)
        return {'rssi': rssi}

    elif command == 'scan_devices':
        devices = scan_devices()
        return {'devices': devices}

# UDP服务器
sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
sock.bind(('0.0.0.0', AP_PORT))

while True:
    data, addr = sock.recvfrom(1024)
    response = handle_request(data)
    sock.sendto(json.dumps(response).encode(), addr)
```

## 功能说明

### 设备列表表格
| 列名 | 说明 |
|------|------|
| MAC地址 | 设备的唯一标识 |
| 位置X/Y/Z | 设备在3D空间中的位置坐标（米） |
| 置信度 | 定位结果的置信度 (0-1) |
| 最后更新 | 最近一次定位的时间 |

### 控制按钮
- **初始化跟踪系统**：创建信号采集器和跟踪器
- **添加模拟设备**：（仅模拟模式）手动添加测试设备
- **开始跟踪**：启动实时定位循环
- **停止跟踪**：停止实时定位
- **扫描设备**：扫描环境中的所有WiFi设备
- **查看实时地图**：生成3D可视化地图
- **刷新列表**：手动刷新设备列表

## 系统架构

```
┌─────────────────┐
│  WiFi 设备      │  ← 目标（手机、电脑等）
│  (非合作)       │
└────────┬────────┘
         │ 发射WiFi信号
         ↓
┌─────────────────────────────────────┐
│  AP1   AP2   AP3   AP4              │
│  (监听RSSI)                         │
└─────────┬───────────────────────────┘
          │ RSSI数据
          ↓
┌─────────────────────────────────────┐
│  信号采集器 (SignalCollector)       │
│  - 模拟模式：从指纹库/仿真获取      │
│  - 真实模式：从AP设备采集           │
└─────────┬───────────────────────────┘
          │ RSSI向量
          ↓
┌─────────────────────────────────────┐
│  定位引擎 (LocalizationEngine)      │
│  - 指纹匹配 (WKNN/KNN/Probabilistic) │
└─────────┬───────────────────────────┘
          │ 位置坐标
          ↓
┌─────────────────────────────────────┐
│  设备跟踪器 (DeviceTracker)          │
│  - 管理多设备                        │
│  - 存储轨迹历史                      │
│  - 实时更新                          │
└─────────┬───────────────────────────┘
          │
          ↓
    GUI 显示和可视化
```

## 技术原理

### 1. 信号采集
- **模拟模式**：从指纹库查询或通过射线追踪仿真生成RSSI
- **真实模式**：AP设备监听WiFi信号，测量RSSI强度

### 2. 定位算法
使用与"定位测试"相同的算法：
- **WKNN**：加权K近邻（默认）
- **KNN**：K近邻
- **Probabilistic**：概率法

### 3. 实时跟踪
- 每1秒采集一次RSSI并定位
- 自动管理多个设备
- 记录最近100个位置点的轨迹
- 自动清除30秒未更新的设备

## 常见问题

### Q1: 模拟模式下添加设备后看不到定位结果？
**A**: 确保：
1. 已在"定位测试"页面加载指纹库
2. 点击了"初始化跟踪系统"
3. 点击了"开始跟踪"
4. 设备位置在指纹库覆盖范围内

### Q2: 真实AP模式无法连接AP？
**A**: 检查：
1. AP设备IP地址是否正确
2. 端口号是否匹配（默认9999）
3. AP设备是否运行了监听程序
4. 网络是否连通（可以ping测试）

### Q3: 定位精度不高怎么办？
**A**: 尝试：
1. 增加指纹库密度（减小网格间距）
2. 增加AP数量（推荐4-6个）
3. 优化AP布局（四角分布最佳）
4. 调整K值（K=4-8效果较好）

### Q4: 可以同时跟踪多少个设备？
**A**: 理论上无限制，但建议：
- 模拟模式：10-20个（性能考虑）
- 真实模式：取决于AP设备性能

### Q5: 实时地图卡顿怎么办？
**A**:
- 指纹点已自动降采样到500个
- 如果仍然卡顿，关闭浏览器其他标签页
- 或在代码中进一步减少采样点

## 注意事项

⚠️ **法律和隐私**：
- 真实AP模式涉及WiFi信号监听，可能涉及隐私问题
- 仅在合法授权的环境中使用
- 商业应用前请咨询法律顾问

⚠️ **技术限制**：
- 模拟模式的精度取决于指纹库质量和仿真准确度
- 真实模式需要专业WiFi设备（支持Monitor Mode）
- 定位精度受环境、AP布局、算法等多因素影响

⚠️ **性能建议**：
- 指纹库过大时，初始化可能需要几秒钟
- 实时跟踪会持续占用CPU资源
- 不使用时请停止跟踪

## 下一步

1. **优化定位**：调整指纹库参数和定位算法
2. **轨迹分析**：导出设备轨迹数据进行分析
3. **集成应用**：将定位数据接入其他系统
4. **硬件部署**：搭建真实环境进行测试
5. **探索多信号类型**: 查看[通用电磁信号跟踪说明.md](通用电磁信号跟踪说明.md)了解如何追踪更多类型的设备

## 技术支持

如有问题，请查看系统日志（GUI底部"系统日志"区域）获取详细错误信息。
